---
title: List
layout: default
classes: wide 
---
<TITLE>List</TITLE>
<SCRIPT>
	var sortcol = "peripheral";
	var ascending = true;
	var reason = "";
	var found = 0;
	
	window.addEventListener('load', function () {
		query();
		makeselect("companies", enum_property("company"), "Companies");
		makeselect("systems", enum_consoles(), "Systems");
		makeselect("sections", Object.keys(sections), "Sections");
		makeselect("locations", enum_property("location"), "Locations");
	});
	
	function sortby(column){
		if(column == sortcol){
			ascending = !ascending;
		} else {
			ascending = true;
			sortcol = column;
		}
		query();
	}
	
	function test_controller(controller, text = "", sect = "", comp = "", syst = ""){
		var istext = text.length == 0, issect = sect.length == 0, iscomp = comp.length == 0, issyst = syst.length == 0, ismatch = istext && issect && iscomp && issyst;
		if(!istext){
			istext = gp(controller, "company").contains(text) || gp(controller, "peripheralName").contains(text);
		}
		if(!issect){
			issect = controller_section(controller) == sect;
		}
		if(!iscomp){
			iscomp = gp(controller, "company") == comp;
		}
		if(!issyst){
			issyst = gp(controller, "systems").split("/").indexOf(syst) > -1;
		}

		if(ismatch || (istext && issect && iscomp && issyst)){
			reason = [];
			if(ismatch){
					reason.push("no search");
			} else {
					if(text.length > 0){
						reason.push("text (" + text + ")");
					}
					if(sect.length > 0){
						reason.push("section (" + sect + ")");
					}
					if(comp.length > 0){
						reason.push("company (" + comp + ")");
					}
					if(syst.length > 0){
						reason.push("systems (" + syst + ")");
					}
			}
			reason = reason.join(", ");
			return true;
		}
		return false;
	}

	var stats = {};
	function add2stats(controller, period = null, type = null){
		if(period === null && type === null){
			var date = false;
			var year = "unknown";
			stats = {
				"years": {},
				"months": {},
			};
			if(controller.hasOwnProperty("obtained") && validatedate(controller.obtained)){
				date = controller.obtained.left(7);
				year = controller.obtained.left(4);
			}
			add2stats(controller, "total", "years");
			add2stats(controller, year, "years");
			add2stats(controller, date, "months");
		} else if(period){
			var cost = 0;
			if(controller.hasOwnProperty("cost") && isNumeric(controller.cost)){
				cost = controller.cost;
			}
			if(!stats[ type ].hasOwnProperty(period)){
				stats[ type ][ period ] = {};
			}			
			if(controller.hasOwnProperty("company")){
				if(!stats[ type ][ period ].hasOwnProperty(controller.company)){
					stats[ type ][ period ][ controller.company ] = {
						type: 0,
						quantity: 0, 
						cost: 0,
						controllers: [],
					};
				}
				stats[ type ][ period ][ controller.company ].quantity ++;
				stats[ type ][ period ][ controller.company ].cost += cost;
				stats[ type ][ period ][ controller.company ].controllers.push(controller.peripheralName);
			}
			if(controller.hasOwnProperty("systems")){
				var systems = controller.systems.split("/");
				for(var i = 0; i < systems.length; i++){
					if(!stats[ type ][ period ].hasOwnProperty(systems[i])){
						stats[ type ][ period ][ systems[i] ] = {
							type: 1,
							quantity: 0, 
							cost: 0,
							controllers: [],
						};
					}
					stats[ type ][ period ][ systems[i] ].quantity ++;
					stats[ type ][ period ][ systems[i] ].cost += cost;
					stats[ type ][ period ][ systems[i] ].controllers.push(controller.peripheralName);
				}
			}
		}
	} 
	
	function enum_controllers(){
		var ret = [];
		var text = set_HTML("searchtext", null, "val");
		var sect = set_HTML("sections", null, "val");
		var comp = set_HTML("companies", null, "val");
		var syst = set_HTML("systems", null, "val");
		console.log("Querying text: '" + text + "' section: '" + sect + "' company: '" + comp + "' system: '" + syst + "'");
		for(var i = 0; i < controllers.length; i++){
			var controller = controllers[i];
			if(test_controller(controller, text, sect, comp, syst)){
				controller.reason = reason;
				add2stats(controller);
				ret.push(controller);
			} else {
				console.log(controller.peripheralName + ": " + reason);
			}
		}
		found = ret.length;
		ret.sort(dynamicSortMultiple(sortby));
		if(!ascending){
			ret.reverse();
		}
		return ret;
	}

	function validatedate(text){
		if(text.length > 7 && text.length < 11){
			text = text.split("-");
			if(text.length === 3 && isNumeric(text[0]) && isNumeric(text[1]) && isNumeric(text[2])){
				if(text[0].length == 4 && text[1] > 0 && text[1] < 13 && text[2] > 0){
					return text[2] <= daysInMonth(text[1], text[0]);
				}
			}
		}
		return false;
	}

	function query(){
		var HTML = "";
		var ret = enum_controllers(controllers);
		for(var i = 0; i < ret.length; i++){
			var controller = ret[i];
			var A = '<A HREF="/' + controller_section(controller, true) + "#" + toclassname(controller.peripheralName) + '">';
			var TD = '</A></TD><TD>' + A;
			HTML += '<TR TITLE="' + controller.reasons + '"><TD ALIGN="center">' + A + gp(controller, "peripheral") + TD + gp(controller, "company") + TD + controller.peripheralName + TD + gp(controller, "obtained") + TD + gp(controller, "systems") + '</A></TD></TR>'
		}
		set_HTML("controllers", HTML);
		set_HTML("footer", "Found " + found + " out of " + controllers.length + " peripherals");
		return HTML;
	}
	
	function gp(controller, property, def = ""){
		if(controller.hasOwnProperty(property)){
				return controller[property];
		}
		return def;
	}
	
	function makeselect(ID, options, name = false){
		var HTML = "";
		var value = _GET(ID);
		if(name){
			HTML = '<OPTION VALUE="" CLASS="bold">' + name + '</OPTION>';
		}
		options.sort();
		for(var i = 0; i < options.length; i++){
			HTML += '<OPTION';
			if(value == options[i]){
				HTML += " SELECTED";
			}
			HTML += '>' + options[i] + '</OPTION>';
		}
		set_HTML(ID, HTML);
		return HTML;
	}
	
	function enum_property(name){
		var ret = [];
		for(var i = 0; i < controllers.length; i++){
			if(controllers[i].hasOwnProperty(name)){
				if(ret.indexOf(controllers[i][name]) == -1){
					ret.push(controllers[i][name]);
				}
			}
		}
		return ret;
	}
</SCRIPT>

<TABLE CLASS="table">
	<THEAD>
			<TR>
				<TD COLSPAN="5">
					<INPUT TYPE="text" ID="searchtext" ONKEYUP="query();" PLACEHOLDER="Search">
					<SELECT ID="sections" ONCHANGE="query();"></SELECT>
					<SELECT ID="companies" ONCHANGE="query();"></SELECT>
					<SELECT ID="systems" ONCHANGE="query();"></SELECT>
					<SELECT ID="locations" ONCHANGE="query();"></SELECT>
				</TD>
			</TR>
			<TR STYLE="cursor: pointer;">
				<TH ONCLICK="sortby('peripheral');">ID</TH>
				<TH ONCLICK="sortby('company');">Company</TH>
				<TH ONCLICK="sortby('peripheralName');">Peripheral Name</TH>
				<TH ONCLICK="sortby('obtained');">Obtained</TH>
				<TH ONCLICK="sortby('systems');">Systems</TH>
			</TR>
	</THEAD>
	<TBODY ID="controllers"></TBODY>
	<TFOOT>
			<TR>
				<TD COLSPAN="5" ID="footer"></TD>
		</TR>
	</TFOOT>
</TABLE>

<STYLE>
	.table thead{
			position: sticky;
			top: 50px;
	}
</STYLE>	
